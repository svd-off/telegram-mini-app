<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Городской Транспорт</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#000;color:#FFF;height:100vh;overflow:hidden;}
        .app-container{height:100%;display:flex;flex-direction:column;padding:0 16px 30px;}
        .page{display:none;flex-direction:column;height:100%;}.page.active{display:flex;}
        #accessDenied{position:fixed;top:0;left:0;width:100%;height:100%;background:#000;display:flex;align-items:center;justify-content:center;z-index:9999;font-size:32px;color:#FF3B30;font-weight:900;}

        /* КНОПКА ВЫБОРА ИЗ БАЗЫ */
        .database-btn{background:#007AFF;color:#FFF;font-size:17px;font-weight:600;padding:16px 0;border-radius:12px;text-align:center;cursor:pointer;margin-bottom:16px;}
        .database-btn:active{background:#0056CC;}

        /* ПОЛЯ */
        input[type=text]{background:#1E1E1E;border:1px solid #3A3A3C;border-radius:12px;padding:14px;color:#FFF;font-size:16px;width:100%;margin-bottom:16px;}

        /* КНОПКИ КОЛИЧЕСТВА */
        .quantity-selector{margin:20px 0;}
        .quantity-title{font-size:16px;color:#AAA;margin-bottom:10px;}
        .quantity-buttons{display:flex;gap:10px;}
        .quantity-btn{flex:1;background:#333;color:#FFF;padding:16px;border-radius:12px;font-size:18px;font-weight:600;text-align:center;cursor:pointer;}
        .quantity-btn.active{background:#30D158;color:#000;}
        .quantity-btn:active{transform:scale(0.98);}

        /* ЦЕНА */
        .price-selector{background:#1E1E1E;border-radius:12px;padding:16px;margin:16px 0;cursor:pointer;}
        .price-options{display:none;background:#111;padding:12px;border-radius:12px;margin-bottom:16px;}
        .price-btn{background:#333;color:#FFF;padding:14px;border-radius:12px;text-align:center;margin-bottom:10px;cursor:pointer;}
        .custom-price-row{display:flex;gap:8px;}
        .custom-price{flex:1;background:#000;border:1px solid #444;padding:12px;border-radius:12px;color:#FFF;text-align:center;}
        .apply-btn{background:#30D158;color:#000;padding:12px 16px;border-radius:12px;cursor:pointer;}

        /* КНОПКА ОПЛАТЫ */
        .pay-button{background:#30D158;color:#000;font-size:18px;font-weight:600;padding:20px;border-radius:16px;text-align:center;margin-top:auto;cursor:pointer;}
        .pay-button:active{background:#28A745;}

        /* МОДАЛЬНОЕ ОКНО */
        #routeModal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.98);z-index:99999;display:none;flex-direction:column;}
        .modal-header{padding:20px 16px;border-bottom:1px solid #333;display:flex;justify-content:space-between;align-items:center;}
        .modal-title{font-size:20px;font-weight:600;}
        .modal-close{width:36px;height:36px;background:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="%23FFF" stroke-width="3"><path d="M18 6L6 18M6 6l12 12"/></svg>') center/contain no-repeat;cursor:pointer;}
        .modal-search{padding:16px;background:#111;}
        #searchInput{width:100%;background:#222;border:none;border-radius:12px;padding:14px;color:#FFF;font-size:16px;}
        .modal-content{flex:1;overflow-y:auto;padding:16px;}
        .route-item{background:#1E1E1E;border-radius:12px;padding:18px;margin-bottom:12px;cursor:pointer;transition:0.2s;}
        .route-item:active{background:#2A2A2C;transform:scale(0.98);}
        .route-number{font-size:22px;font-weight:700;margin-bottom:6px;}
        .route-name{font-size:18px;font-weight:600;margin-bottom:8px;}
        .route-carrier{font-size:15px;color:#888;}

        /* БИЛЕТЫ */
        .final-timer{font-size:26px;text-align:center;margin:20px 0;}
        .final-close-btn{background:#FF3B30;color:#FFF;padding:18px;border-radius:16px;text-align:center;margin-top:auto;cursor:pointer;}
        .final-close-btn:active{background:#D91A10;}
        .active-tickets-list{flex:1;overflow-y:auto;margin-bottom:12px;}
        .active-ticket-item{background:#1E1E1E;border-radius:12px;padding:16px;margin-bottom:12px;cursor:pointer;}
        .active-ticket-item:active{background:#2A2A2C;}
        .close-button{background:#333;color:#FFF;padding:16px;border-radius:12px;text-align:center;margin-top:16px;cursor:pointer;}
    </style>
</head>
<body>

    <div id="accessDenied" style="display:none;">ДОСТУП ЗАПРЕЩЁН</div>

    <div class="app-container" id="mainApp" style="display:none;">

        <!-- ОПЛАТА -->
        <div id="paymentPage" class="page active">
            <div style="font-size:18px;font-weight:600;margin-bottom:16px;">Данные билета</div>

            <div class="database-btn" onclick="openRouteModal()">Выбрать из базы маршрутов</div>

            <input type="text" id="carrierInput" placeholder="Перевозчик">
            <input type="text" id="routeInput" placeholder="Маршрут">
            <input type="text" id="busNumberInput" placeholder="Номер автобуса">

            <div class="quantity-selector">
                <div class="quantity-title">Количество билетов:</div>
                <div class="quantity-buttons">
                    <button class="quantity-btn active" onclick="setQuantity(1)">1</button>
                    <button class="quantity-btn" onclick="setQuantity(2)">2</button>
                    <button class="quantity-btn" onclick="setQuantity(3)">3</button>
                    <button class="quantity-btn" onclick="setQuantity(4)">4)">4</button>
                    <button class="quantity-btn" onclick="setQuantity(5)">5</button>
                </div>
            </div>

            <div class="price-selector" onclick="document.getElementById('priceOptions').style.display=document.getElementById('priceOptions').style.display==='block'?'none':'block'">
                Цена за 1 билет: <span id="currentPriceText">48.00 ₽</span>
            </div>
            <div id="priceOptions" class="price-options">
                <div class="price-btn" onclick="setPrice(48)">48.00 ₽</div>
                <div class="price-btn" onclick="setPrice(46)">46.00 ₽</div>
                <div class="custom-price-row">
                    <input type="number" id="customPriceInput" class="custom-price" placeholder="Своя цена">
                    <div class="apply-btn" onclick="applyCustomPrice()">OK</div>
                </div>
            </div>

            <div class="pay-button" onclick="payTicket()">ОПЛАТИТЬ — <span id="totalPrice">48.00 ₽</span></div>
        </div>

        <!-- ФИНАЛЬНЫЙ БИЛЕТ -->
        <div id="finalTicketPage" class="page">
            <div style="flex:1;display:flex;flex-direction:column;">
                <div class="top-separator"></div>
                <div class="final-timer" id="timer">Действует: 15 сек.</div>
                <div style="padding:0 16px;flex:1;">
                    <div style="background:#111;border-radius:16px;padding:20px;">
                        <div style="font-size:18px;font-weight:600;margin-bottom:16px;text-align:center;">Электронный билет</div>
                        <div style="font-size:24px;font-weight:700;text-align:center;margin-bottom:20px;" id="finalRouteFromTo">Соколовская — Стела</div>
                        <div style="font-size:18px;text-align:center;color:#30D158;margin-bottom:20px;" id="finalBusNumber">в523ок124</div>
                        <div style="font-size:16px;color:#888;margin-bottom:8px;">Перевозчик</div>
                        <div style="font-size:20px;font-weight:600;margin-bottom:20px;" id="finalCarrier">ИП Читащвили Н.С.</div>
                        <div style="font-size:16px;color:#888;margin-bottom:8px;">Стоимость</div>
                        <div style="font-size:20px;font-weight:600;" id="finalCost">1 шт., Полный, 48.00 ₽</div>
                    </div>
                </div>
                <div class="final-close-btn" onclick="closeTicket()">ЗАКРЫТЬ</div>
            </div>
        </div>

        <!-- АКТИВНЫЕ БИЛЕТЫ -->
        <div id="activeTicketsPage" class="page">
            <div style="flex:1;display:flex;flex-direction:column;">
                <div style="font-size:18px;font-weight:600;margin-bottom:16px;">Действующие билеты</div>
                <div class="active-tickets-list" id="activeTicketsList"></div>
                <div class="close-button" onclick="showPage('paymentPage')">Назад</div>
            </div>
        </div>
    </div>

    <!-- МОДАЛЬНОЕ ОКНО С БАЗОЙ -->
    <div id="routeModal" onclick="if(event.target===this){closeRouteModal();document.activeElement.blur();}">
        <div class="modal-header">
            <div class="modal-title">Выбор маршрута</div>
            <div class="modal-close" onclick="closeRouteModal()"></div>
        </div>
        <div class="modal-search">
            <input type="text" id="searchInput" placeholder="Поиск по маршруту..." oninput="filterRoutes()">
        </div>
        <div class="modal-content" id="routesList"></div>
    </div>

    <script>
        const ALLOWED_USERS = [6107814655, 1777702236];
        const tg = window.Telegram.WebApp;
        tg.expand(); tg.MainButton.hide();
        const userId = tg.initDataUnsafe?.user?.id;

        if (!userId || !ALLOWED_USERS.includes(userId)) {
            document.getElementById('accessDenied').style.display = 'flex';
        } else {
            document.getElementById('mainApp').style.display = 'flex';
        }

        let viewTimer, viewSecondsLeft = 15;
        const TOTAL_DURATION = 90 * 60 * 1000;
        let tickets = JSON.parse(localStorage.getItem('user_tickets') || '[]');
        const now = Date.now();
        tickets = tickets.filter(t => now - t.created_at < TOTAL_DURATION);
        localStorage.setItem('user_tickets', JSON.stringify(tickets));
        if (tickets.length > 0) showPage('activeTicketsPage'); else showPage('paymentPage');

        let ticketPrice = 48.00;
        let currentQuantity = 1;

        // ВСЯ ТВОЯ БАЗА МАРШРУТОВ — 18 ШТУК, ВСЁ КРАСИВО
        const routesDatabase = [
            { route: "мкрн. Северный - мкрн. Тихие зори", carrier: "МП Городской транспорт" },
            { route: "ОАО \"Русал\" - Сельхозкомплекс", carrier: "МП Городской транспорт" },
            { route: "Автовокзал Восточный - Петрушина", carrier: "ИП Цугленок М.М." },
            { route: "Академгородок - Солнечный", carrier: "ООО КПАТП" },
            { route: "Соколовская - Стела", carrier: "ИП Читашвили Н.С." },
            { route: "ЛДК - ОАО \"РУСАЛ\"", carrier: "ИП Гнетов Ю.Н." },
            { route: "ст.Красноярск-Северный - Экопарк Гремячая грива", carrier: "МП Городской транспорт" },
            { route: "ДК Кировский - Агротерминал", carrier: "ИП Ялтонский А. М." },
            { route: "мкрн. Северный - пос. Удачный", carrier: "КПАТП-7" },
            { route: "Спортзал - мкрн. Тихие зори", carrier: "КПАТП-5" },
            { route: "Кардиоцентр – Спорткомплекс \"Радуга\"", carrier: "КПАТП-5" },
            { route: "Солнечный – Молодежная", carrier: "КПАТП-5" },
            { route: "Междугородный автовокзал - В.Базаиха", carrier: "ООО \"СКАД\"" },
            { route: "Дом учёных - пр. Ульяновский", carrier: "ИП Цугленок М.М." },
            { route: "Полигон - Преображенский", carrier: "ИП Ялтонский А. М." },
            { route: "ст. Красноярск-Северный - ДК Кировский", carrier: "ИП Галченкова Е. А." },
            { route: "Ж/д больница - Сибирский элемент", carrier: "ООО Сирена" },
            { route: "ж/д вокзал - Фан-парк Бобровый лог - пос.Базаиха", carrier: "КПАТП-7" }
        ];

        function openRouteModal() {
            document.getElementById('routeModal').style.display = 'flex';
            renderRoutes();
        }
        function closeRouteModal() {
            document.getElementById('routeModal').style.display = 'none';
        }
        function renderRoutes(filter = '') {
            const list = document.getElementById('routesList');
            list.innerHTML = '';
            const filtered = routesDatabase.filter(r =>
                r.route.toLowerCase().includes(filter.toLowerCase()) ||
                r.carrier.toLowerCase().includes(filter.toLowerCase())
            );
            if (filtered.length === 0) {
                list.innerHTML = '<div style="text-align:center;color:#666;padding:80px 20px;font-size:17px;">Ничего не найдено</div>';
                return;
            }
            filtered.forEach(r => {
                const el = document.createElement('div');
                el.className = 'route-item';
                el.onclick = () => {
                    document.getElementById('carrierInput').value = r.carrier;
                    document.getElementById('routeInput').value = r.route;
                    document.getElementById('busNumberInput').value = '';
                    closeRouteModal();
                    tg.showPopup({title:"Готово!", message:"Данные подставлены!"});
                };
                el.innerHTML = `
                    <div class="route-number">${r.route.split(':')[0].trim()}</div>
                    <div class="route-name">${r.route.includes(':') ? r.route.split(':')[1].trim() : r.route}</div>
                    <div class="route-carrier">${r.carrier}</div>
                `;
                list.appendChild(el);
            });
        }
        function filterRoutes() {
            renderRoutes(document.getElementById('searchInput').value);
        }

        function setQuantity(q) {
            currentQuantity = q;
            document.querySelectorAll('.quantity-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            updatePrice();
        }
        function updatePrice() {
            document.getElementById('totalPrice').textContent = (ticketPrice * currentQuantity).toFixed(2) + ' ₽';
        }
        function setPrice(p) { ticketPrice = p; document.getElementById('currentPriceText').textContent = p.toFixed(2)+' ₽'; document.getElementById('priceOptions').style.display='none'; updatePrice(); }
        function applyCustomPrice() { const v=document.getElementById('customPriceInput').value; if(v>0) setPrice(parseFloat(v)); }

        // ВСЁ ОСТАЛЬНОЕ — ПОЛНОСТЬЮ РАБОЧЕЕ
        function payTicket() {
            const qty = currentQuantity;
            const carrier = document.getElementById('carrierInput').value.trim() || "ИП Читащвили Н.С.";
            const route = document.getElementById('routeInput').value.trim();
            const busNumber = document.getElementById('busNumberInput').value.trim().toLowerCase();
            const total = (ticketPrice * qty).toFixed(2);
            const num = `1 ${r3()} ${r3()} ${r3()}`;
            const d = new Date();
            const date = d.toLocaleDateString('ru-RU',{day:'2-digit',month:'long',year:'numeric'}).replace(/ \d{4}/,'') + ' г.';
            const time = d.toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'});

            tickets.push({number:num, carrier, route, busNumber, quantity:qty, price:ticketPrice, created_at:Date.now(), purchaseDate:date, purchaseTime:time});
            localStorage.setItem('user_tickets', JSON.stringify(tickets));

            document.getElementById('currentTicketNumber').textContent = num;
            document.getElementById('finalCarrier').textContent = carrier;
            document.getElementById('finalRouteFromTo').textContent = route.replace(/-/g,'—');
            document.getElementById('finalBusNumber').textContent = busNumber || '—';
            document.getElementById('finalCost').textContent = qty + ' шт., Полный, ' + total + ' ₽';
            document.getElementById('purchaseDate').textContent = date;
            document.getElementById('purchaseTime').textContent = time;

            generateQrCode(num);
            showPage('finalTicketPage');
            startViewTimer();
        }

        function r3(){return Math.floor(Math.random()*900)+100;}
        function generateQrCode(t){document.getElementById('controlQrCode').innerHTML='';new QRCode(document.getElementById('controlQrCode'),{text:t,width:270,height:270,colorDark:"#000",colorLight:"#fff",correctLevel:QRCode.CorrectLevel.H});}
        function startViewTimer(){viewSecondsLeft=15;document.getElementById('timer').textContent='Действует: '+viewSecondsLeft+' сек.';clearInterval(viewTimer);viewTimer=setInterval(()=>{viewSecondsLeft--;document.getElementById('timer').textContent='Действует: '+viewSecondsLeft+' сек.';if(viewSecondsLeft<=0){clearInterval(viewTimer);showPage(tickets.length>0?'activeTicketsPage':'paymentPage');}},1000);}
        function closeTicket(){clearInterval(viewTimer);showPage(tickets.length>0?'activeTicketsPage':'paymentPage');}
        function showPage(id){document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));document.getElementById(id).classList.add('active');}

        document.addEventListener('DOMContentLoaded', () => {
            updatePrice();
        });
    </script>
</body>
</html>
