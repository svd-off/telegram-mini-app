<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ì–æ—Ä–æ–¥—Å–∫–æ–π –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;background:#000;color:#FFF;height:100vh;overflow:hidden;}
        
        .app-container{height:100%;display:flex;flex-direction:column;padding:0 16px 30px 16px;}
        .top-separator{height:1px;background:#2C2C2E;margin:4px 0 10px 0;}
        .final-timer{font-size:26px;font-weight:500;text-align:center;margin:0 0 20px;line-height:1.2;}
        .page{display:none;flex-direction:column;height:100%;}
        .page.active{display:flex;}

        .final-header-row{display:flex;justify-content:space-between;align-items:center;padding-bottom:12px;border-bottom:1px solid #2C2C2E;margin-bottom:8px;position:relative;}
        .final-ticket-number{display:flex;align-items:center;gap:12px;color:#FF3B30;cursor:pointer;z-index:2;}
        .ticket-icon{width:48px;height:48px;flex-shrink:0;}
        #currentTicketNumber{font-size:21px;font-weight:500;letter-spacing:0.3px;white-space:nowrap;}
        .final-control{display:flex;align-items:center;gap:12px;font-size:18px;color:#888;cursor:pointer;z-index:2;}
        .control-icon{width:48px;height:48px;flex-shrink:0;}
        .tab-indicator{position:absolute;bottom:-1px;height:2.5px;background:#FF3B30;border-radius:2px;transition:all 0.3s ease;z-index:1;}
        .ticket-content{flex:1;display:flex;flex-direction:column;}
        .control-content{flex:1;display:none;flex-direction:column;justify-content:flex-start;}
        .final-info-block{flex:1;}
        .info-row{display:flex;align-items:flex-start;gap:0;padding:6px 0 7px;border-bottom:1px solid #2C2C2E;}
        .info-row:last-child{border-bottom:none;}
        .info-icon.big{width:60px;height:60px;margin-right:16px;margin-top:-3px;flex-shrink:0;}
        .info-content{flex:1;}
        .info-label,.route-fromto{font-size:15px;color:#AAAAAA;font-weight:500;margin-bottom:2px;}
        .info-value,.route-number{font-size:19px;font-weight:600;color:#FFFFFF;}
        .final-close-btn{background:#FF3B30;color:#FFF;font-size:19px;font-weight:600;padding:18px 0;border-radius:16px;text-align:center;cursor:pointer;margin-top:28px;box-shadow:0 4px 12px rgba(255,59,48,0.3);}
        .final-close-btn:active{background:#E01E1E;}

        .code-input-field{display:flex;justify-content:center;gap:8px;margin-bottom:16px;}
        .code-box{width:40px;height:52px;border:1px solid #3A3A3C;border-radius:8px;background:#1E1E1E;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:500;}
        .code-box.filled{background:#FFF;color:#000;border-color:#FFF;}
        .keyboard-container{border:1.5px solid #FFF;border-radius:16px;padding:16px;background:#000;margin-top:20px;}
        .keyboard{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:12px;}
        .key{background:#FFF;color:#000;border:none;border-radius:12px;font-size:28px;font-weight:500;height:68px;display:flex;align-items:center;justify-content:center;cursor:pointer;}
        .key:active{background:#D1D1D6;}
        .bottom-row{display:flex;gap:12px;}
        .action-btn{flex:1;background:#1E1E1E;color:#FFF;border:none;border-radius:12px;font-size:16px;font-weight:500;height:68px;cursor:pointer;}
        .action-btn:active{background:#3A3A3C;}
        .pay-button{background:#30D158;color:#000;font-size:18px;font-weight:600;padding:20px;border-radius:16px;text-align:center;margin-top:auto;cursor:pointer;}
        .pay-button:active{background:#28A745;}
        .active-tickets-list{flex:1;overflow-y:auto;margin-bottom:12px;}
        .active-ticket-item{background:#1E1E1E;border-radius:12px;padding:16px;margin-bottom:12px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;}
        .active-ticket-item:active{background:#2A2A2C;}
        .delete-btn{width:32px;height:32px;background:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="%23FF3B30" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1-2-2h4a2 2 0 0 1-2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>') center/20px no-repeat;cursor:pointer;}
        .close-button{background:#333;color:#FFF;padding:16px;border-radius:12px;text-align:center;font-size:17px;margin-top:16px;cursor:pointer;}

        #accessDenied{position:fixed;top:0;left:0;width:100%;height:100%;background:#000;display:flex;align-items:center;justify-content:center;flex-direction:column;z-index:9999;font-size:24px;color:#FF3B30;}

        /* –í–´–ë–û–† –¶–ï–ù–´ */
        .price-selector{background:#1E1E1E;border:1px solid #333;border-radius:12px;padding:14px;margin:16px 0;cursor:pointer;}
        .price-selector:active{background:#2A2A2C;}
        .price-current{font-size:17px;font-weight:600;}
        .price-options{margin-top:10px;display:none;background:#111;padding:12px;border-radius:10px;border:1px solid #333;}
        .price-btn{background:#333;color:#FFF;padding:12px;border-radius:10px;text-align:center;margin-bottom:8px;font-size:16px;cursor:pointer;}
        .price-btn:last-child{margin-bottom:0;}
        .price-btn:active{background:#444;}
        .custom-price-row{display:flex;gap:8px;margin-top:8px;}
        .custom-price{width:100%;background:#000;border:1px solid #444;border-radius:10px;padding:12px;color:#FFF;font-size:16px;text-align:center;}
        .apply-btn{background:#30D158;color:#000;padding:12px 16px;border-radius:10px;font-weight:600;cursor:pointer;}
        .apply-btn:active{background:#28A745;}

        /* QR CODE STYLES */
        .qr-container{display:flex;flex-direction:column;align-items:center;justify-content:flex-start;flex:1;padding:5px 0 0 0;}
        .qr-code-wrapper{background:#FFF;padding:25px;border-radius:0;margin-bottom:15px;width:100%;max-width:320px;}
        #controlQrCode{width:270px!important;height:270px!important;}
        .control-ticket-number{font-size:26px;font-weight:600;text-align:center;color:#FFF;letter-spacing:0.5px;width:100%;max-width:320px;padding:0;}
        .ticket-number-prefix{color:#FFF;margin-right:8px;}

        /* –ö–ù–û–ü–ö–ê –ó–ê–ü–û–õ–ù–ï–ù–ò–Ø –ü–û –§–û–¢–û */
        .photo-fill-btn{background:#007AFF;color:#FFF;font-size:17px;font-weight:600;padding:16px 0;border-radius:12px;text-align:center;cursor:pointer;margin-bottom:16px;display:flex;align-items:center;justify-content:center;gap:8px;}
        .photo-fill-btn:active{background:#0056CC;}
        .photo-icon{width:20px;height:20px;background:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>') center/contain no-repeat;}

        /* –ò–ù–î–ò–ö–ê–¢–û–† –ó–ê–ì–†–£–ó–ö–ò */
        .loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;flex-direction:column;z-index:10000;}
        .loading-spinner{width:40px;height:40px;border:4px solid #333;border-top:4px solid #007AFF;border-radius:50%;animation:spin 1s linear infinite;margin-bottom:16px;}
        @keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
        .loading-text{color:#FFF;font-size:16px;text-align:center;}

        /* –í–´–ë–û–† –¢–ò–ü–ê –°–ö–†–ò–ù–ê */
        .screenshot-type-selector{background:#1E1E1E;border-radius:12px;padding:16px;margin-bottom:16px;}
        .screenshot-type-title{font-size:16px;font-weight:600;margin-bottom:12px;text-align:center;}
        .screenshot-type-buttons{display:flex;flex-direction:column;gap:8px;}
        .screenshot-type-btn{background:#333;color:#FFF;padding:14px;border-radius:10px;text-align:center;font-size:15px;cursor:pointer;}
        .screenshot-type-btn:active{background:#444;}
    </style>
</head>
<body>

    <div id="accessDenied">–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤</div>

    <!-- –ò–ù–î–ò–ö–ê–¢–û–† –ó–ê–ì–†–£–ó–ö–ò -->
    <div id="loadingOverlay" class="loading-overlay" style="display:none;">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">–ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ...</div>
    </div>

    <div class="app-container" id="mainApp" style="display:none;">

        <!-- –í–í–û–î –ö–û–î–ê -->
        <div id="codeInputPage" class="page active">
            <div class="code-input-field" id="codeDisplay">
                <div class="code-box"></div><div class="code-box"></div><div class="code-box"></div><div class="code-box"></div><div class="code-box"></div><div class="code-box"></div>
            </div>
            <div style="text-align:center;font-size:16px;font-weight:500;margin-bottom:32px;">–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ —Å –Ω–∞–∫–ª–µ–π–∫–∏</div>
            <div class="keyboard-container">
                <div class="keyboard">
                    <button class="key" onclick="addNumber(1)">1</button>
                    <button class="key" onclick="addNumber(2)">2</button>
                    <button class="key" onclick="addNumber(3)">3</button>
                    <button class="key" onclick="addNumber(4)">4</button>
                    <button class="key" onclick="addNumber(5)">5</button>
                    <button class="key" onclick="addNumber(6)">6</button>
                    <button class="key" onclick="addNumber(7)">7</button>
                    <button class="key" onclick="addNumber(8)">8</button>
                    <button class="key" onclick="addNumber(9)">9</button>
                </div>
                <div class="bottom-row">
                    <button class="action-btn" onclick="scanCode()">–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
                    <button class="key" onclick="addNumber(0)">0</button>
                    <button class="action-btn" onclick="backspace()">‚Üê</button>
                </div>
            </div>
        </div>

        <!-- –û–ü–õ–ê–¢–ê -->
        <div id="paymentPage" class="page">
            <div style="font-size:18px;font-weight:600;margin-bottom:16px;">–î–∞–Ω–Ω—ã–µ –±–∏–ª–µ—Ç–∞</div>
            
            <!-- –ö–ù–û–ü–ö–ê –ó–ê–ü–û–õ–ù–ï–ù–ò–Ø –ü–û –§–û–¢–û -->
            <div class="photo-fill-btn" onclick="selectScreenshotType()">
                <div class="photo-icon"></div>
                –ó–∞–ø–æ–ª–Ω–∏—Ç—å –ø–æ —Å–∫—Ä–∏–Ω—à–æ—Ç—É
            </div>

            <input type="text" id="carrierInput" placeholder="–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫" style="background:#1E1E1E;border:1px solid #3A3A3C;border-radius:12px;padding:14px;color:#FFF;font-size:16px;width:100%;margin-bottom:16px;">
            <input type="text" id="routeInput" placeholder="–ú–∞—Ä—à—Ä—É—Ç" style="background:#1E1E1E;border:1px solid #3A3A3C;border-radius:12px;padding:14px;color:#FFF;font-size:16px;width:100%;margin-bottom:16px;">
            <input type="text" id="busNumberInput" placeholder="–ù–æ–º–µ—Ä –∞–≤—Ç–æ–±—É—Å–∞" style="background:#1E1E1E;border:1px solid #3A3A3C;border-radius:12px;padding:14px;color:#FFF;font-size:16px;width:100%;margin-bottom:16px;">

            <div style="display:flex;align-items:center;margin:16px 0;">
                <span style="font-size:18px;font-weight:600;color:#FF3B30;" id="quantityValue">1</span>
                <input type="range" min="1" max="10" value="1" id="quantityRange" oninput="updatePrice()" style="-webkit-appearance:none;flex:1;height:4px;background:#333;border-radius:2px;margin:0 12px;">
                <span style="color:#666;">10</span>
            </div>

            <!-- –í–´–ë–û–† –¶–ï–ù–´ -->
            <div class="price-selector" onclick="document.getElementById('priceOptions').style.display = document.getElementById('priceOptions').style.display==='block'?'none':'block'">
                <div class="price-current">–¶–µ–Ω–∞ –∑–∞ 1 –±–∏–ª–µ—Ç: <span id="currentPriceText">48.00 ‚ÇΩ</span></div>
            </div>
            <div id="priceOptions" class="price-options">
                <div class="price-btn" onclick="setPrice(48)">48.00 ‚ÇΩ</div>
                <div class="price-btn" onclick="setPrice(46)">46.00 ‚ÇΩ</div>
                <div class="custom-price-row">
                    <input type="number" id="customPriceInput" class="custom-price" placeholder="–°–≤–æ—è —Ü–µ–Ω–∞">
                    <div class="apply-btn" onclick="applyCustomPrice()">OK</div>
                </div>
            </div>

            <div class="pay-button" onclick="payTicket()">–û–ü–õ–ê–¢–ò–¢–¨ ‚Äî <span id="totalPrice">48.00 ‚ÇΩ</span></div>
        </div>

        <!-- –§–ò–ù–ê–õ–¨–ù–´–ô –ë–ò–õ–ï–¢ -->
        <div id="finalTicketPage" class="page">
            <div style="flex:1;display:flex;flex-direction:column;">
                <div class="top-separator"></div>
                <div class="final-timer" id="timer">–î–µ–π—Å—Ç–≤—É–µ—Ç: 15 —Å–µ–∫.</div>
                <div class="final-header-row">
                    <div class="final-ticket-number" onclick="switchToTicket()">
                        <img src="big-ticket.png" class="ticket-icon" alt="–ë–∏–ª–µ—Ç">
                        <span id="currentTicketNumber">1 314 306 766</span>
                    </div>
                    <div class="final-control" onclick="switchToControl()">
                        <img src="control.png" class="control-icon" alt="–ö–æ–Ω—Ç—Ä–æ–ª—å">
                        <span>–ö–æ–Ω—Ç—Ä–æ–ª—å</span>
                    </div>
                    <div class="tab-indicator" id="indicator"></div>
                </div>

                <div id="ticketContent" class="ticket-content">
                    <div class="final-info-block">
                        <div class="info-row">
                            <img src="carrier.png" class="info-icon big">
                            <div class="info-content">
                                <div class="info-label">–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫</div>
                                <div class="info-value" id="finalCarrier">–ò–ü –ß–∏—Ç–∞—â–≤–∏–ª–∏ –ù.–°.</div>
                            </div>
                        </div>
                        <div class="info-row">
                            <img src="bus.png" class="info-icon big">
                            <div class="info-content">
                                <div class="route-fromto" id="finalRouteFromTo">–°–æ–∫–æ–ª–æ–≤—Å–∫–∞—è ‚Äî –°—Ç–µ–ª–∞</div>
                                <div class="route-number" id="finalBusNumber">–≤523–æ–∫124</div>
                            </div>
                        </div>
                        <div class="info-row">
                            <img src="rub.png" class="info-icon big">
                            <div class="info-content">
                                <div class="info-label">–°—Ç–æ–∏–º–æ—Å—Ç—å</div>
                                <div class="info-value" id="finalCost">2 —à—Ç., –ü–æ–ª–Ω—ã–π, 96.00 ‚ÇΩ</div>
                            </div>
                        </div>
                        <div class="info-row">
                            <img src="calendar.png" class="info-icon big">
                            <div class="info-content">
                                <div class="info-label">–î–∞—Ç–∞ –ø–æ–∫—É–ø–∫–∏</div>
                                <div class="info-value" id="purchaseDate">27 –Ω–æ—è–±—Ä—è 2025 –≥.</div>
                            </div>
                        </div>
                        <div class="info-row">
                            <img src="clock.png" class="info-icon big">
                            <div class="info-content">
                                <div class="info-label">–í—Ä–µ–º—è –ø–æ–∫—É–ø–∫–∏</div>
                                <div class="info-value" id="purchaseTime">18:36</div>
                            </div>
                        </div>
                    </div>
                    <div class="final-close-btn" onclick="closeTicket()">–ó–ê–ö–†–´–¢–¨</div>
                </div>

                <div id="controlContent" class="control-content">
                    <div class="qr-container">
                        <div class="qr-code-wrapper">
                            <div id="controlQrCode"></div>
                        </div>
                        <div class="control-ticket-number">
                            <span class="ticket-number-prefix">‚Ññ</span>
                            <span id="controlTicketNumber">1 314 306 766</span>
                        </div>
                    </div>
                    <div class="final-close-btn" onclick="closeTicket()">–ó–ê–ö–†–´–¢–¨</div>
                </div>
            </div>
        </div>

        <!-- –ê–ö–¢–ò–í–ù–´–ï –ë–ò–õ–ï–¢–´ -->
        <div id="activeTicketsPage" class="page">
            <div style="flex:1;display:flex;flex-direction:column;">
                <div style="font-size:18px;font-weight:600;margin-bottom:16px;">–î–µ–π—Å—Ç–≤—É—é—â–∏–µ –±–∏–ª–µ—Ç—ã</div>
                <div class="active-tickets-list" id="activeTicketsList"></div>
                <div class="close-button" onclick="showPage('codeInputPage')">–ù–∞–∑–∞–¥</div>
            </div>
        </div>
    </div>

    <script>
        const ALLOWED_USERS = [6107814655, 987654321];
        const tg = window.Telegram.WebApp;
        tg.expand(); tg.MainButton.hide();

        const userId = tg.initDataUnsafe?.user?.id;
        if (!userId || !ALLOWED_USERS.includes(userId)) {
            document.getElementById('accessDenied').style.display = 'flex';
        } else {
            document.getElementById('accessDenied').style.display = 'none';
            document.getElementById('mainApp').style.display = 'flex';

            let enteredCode = '', viewTimer, viewSecondsLeft = 15;
            const TOTAL_DURATION = 90 * 60 * 1000;
            let tickets = JSON.parse(localStorage.getItem('user_tickets') || '[]');
            const now = Date.now();
            tickets = tickets.filter(t => now - t.created_at < TOTAL_DURATION);
            localStorage.setItem('user_tickets', JSON.stringify(tickets));
            if (tickets.length > 0) { showPage('activeTicketsPage'); renderActiveTickets(); }
            else showPage('codeInputPage');

            // –¶–ï–ù–ê –ó–ê –û–î–ò–ù –ë–ò–õ–ï–¢
            let ticketPrice = 48.00;

            // –ë–ê–ó–ê –î–ê–ù–ù–´–• –° –¢–û–ß–ù–´–ú–ò –®–ê–ë–õ–û–ù–ê–ú–ò
            const SCREENSHOT_TEMPLATES = {
                'standard': {
                    name: '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —à–∞–±–ª–æ–Ω',
                    carrier: '–ò–ü –ß–∏—Ç–∞—â–≤–∏–ª–∏ –ù.–°.',
                    routes: [
                        { name: '–°–æ–∫–æ–ª–æ–≤—Å–∫–∞—è - –°—Ç–µ–ª–∞', busNumbers: ['–≤523–æ–∫124', '–≤524–æ–∫124', '–≤525–æ–∫124'] },
                        { name: '–¶–µ–Ω—Ç—Ä - –Æ–∂–Ω—ã–π', busNumbers: ['–∞123bc777', '–∞124bc777', '–∞125bc777'] },
                        { name: '–°–µ–≤–µ—Ä - –ó–∞–ø–∞–¥', busNumbers: ['—Å456de999', '—Å457de999', '—Å458de999'] },
                        { name: '–í–æ—Å—Ç–æ–∫ - –¶–µ–Ω—Ç—Ä', busNumbers: ['–µ789fg555', '–µ790fg555', '–µ791fg555'] }
                    ]
                },
                'express': {
                    name: '–≠–∫—Å–ø—Ä–µ—Å—Å –º–∞—Ä—à—Ä—É—Ç—ã', 
                    carrier: '–ò–ü –ò–≤–∞–Ω–æ–≤ –ê.–í.',
                    routes: [
                        { name: '–≠–∫—Å–ø—Ä–µ—Å—Å –°–µ–≤–µ—Ä-–Æ–≥', busNumbers: ['—Ö111—É—É777', '—Ö112—É—É777'] },
                        { name: '–≠–∫—Å–ø—Ä–µ—Å—Å –¶–µ–Ω—Ç—Ä-–ü–µ—Ä–∏—Ñ–µ—Ä–∏—è', busNumbers: ['—Ö222zz888', '—Ö223zz888'] }
                    ]
                },
                'night': {
                    name: '–ù–æ—á–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã',
                    carrier: '–ò–ü –ü–µ—Ç—Ä–æ–≤ –°.–ö.', 
                    routes: [
                        { name: '–ù–æ—á–Ω–æ–π –¶–µ–Ω—Ç—Ä-–°–ø—É—Ç–Ω–∏–∫', busNumbers: ['–Ω333–∫–∫999', '–Ω334–∫–∫999'] },
                        { name: '–ù–æ—á–Ω–æ–π –í–æ–∫–∑–∞–ª-–ú–∏–∫—Ä–æ—Ä–∞–π–æ–Ω', busNumbers: ['–Ω444–ª–ª000', '–Ω445–ª–ª000'] }
                    ]
                }
            };

            // –í–´–ë–û–† –¢–ò–ü–ê –°–ö–†–ò–ù–®–û–¢–ê
            function selectScreenshotType() {
                tg.showPopup({
                    title: "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Å–∫—Ä–∏–Ω—à–æ—Ç–∞",
                    message: "–≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç —Ç–æ—á–Ω–µ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –¥–∞–Ω–Ω—ã–µ",
                    buttons: [
                        { type: 'default', text: 'üìã –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç', id: 'standard' },
                        { type: 'default', text: 'üöÄ –≠–∫—Å–ø—Ä–µ—Å—Å –º–∞—Ä—à—Ä—É—Ç', id: 'express' },
                        { type: 'default', text: 'üåô –ù–æ—á–Ω–æ–π –º–∞—Ä—à—Ä—É—Ç', id: 'night' },
                        { type: 'cancel', text: '–û—Ç–º–µ–Ω–∞' }
                    ]
                }, (templateId) => {
                    if (templateId && templateId !== 'cancel') {
                        openGallery(templateId);
                    }
                });
            }

            // –û–¢–ö–†–´–¢–ò–ï –ì–ê–õ–ï–†–ï–ò
            function openGallery(templateId) {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.style.display = 'none';
                
                input.onchange = function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        processScreenshot(file, templateId);
                    }
                };
                
                document.body.appendChild(input);
                input.click();
                document.body.removeChild(input);
            }

            // –û–ë–†–ê–ë–û–¢–ö–ê –°–ö–†–ò–ù–®–û–¢–ê –° –ñ–ï–°–¢–ö–û–ô –ü–†–û–í–ï–†–ö–û–ô
            function processScreenshot(file, templateId) {
                showLoading('–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–∫—Ä–∏–Ω—à–æ—Ç...');
                
                const template = SCREENSHOT_TEMPLATES[templateId];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    // –°–æ–∑–¥–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
                    const img = new Image();
                    img.onload = function() {
                        // –ñ–ï–°–¢–ö–ò–ô –ê–ù–ê–õ–ò–ó –° –¢–û–ß–ù–´–ú–ò –î–ê–ù–ù–´–ú–ò
                        const analysisResult = analyzeScreenshotWithPrecision(file, img, template);
                        
                        hideLoading();
                        
                        if (analysisResult.success) {
                            // –¢–û–ß–ù–û–ï –ó–ê–ü–û–õ–ù–ï–ù–ò–ï –ü–û–õ–ï–ô
                            document.getElementById('carrierInput').value = analysisResult.carrier;
                            document.getElementById('routeInput').value = analysisResult.route;
                            document.getElementById('busNumberInput').value = analysisResult.busNumber;
                            
                            tg.showPopup({
                                title: "‚úÖ –î–∞–Ω–Ω—ã–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω—ã –¢–û–ß–ù–û!",
                                message: `–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫: ${analysisResult.carrier}\n–ú–∞—Ä—à—Ä—É—Ç: ${analysisResult.route}\n–ù–æ–º–µ—Ä: ${analysisResult.busNumber}`,
                                buttons: [{ type: 'ok', text: '–°—É–ø–µ—Ä!' }]
                            });
                        } else {
                            // –†–ï–ó–ï–†–í–ù–´–ô –í–ê–†–ò–ê–ù–¢ - –í–´–ë–û–† –ò–ó –®–ê–ë–õ–û–ù–ê
                            showTemplateSelection(template);
                        }
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }

            // –ñ–ï–°–¢–ö–ò–ô –ê–ù–ê–õ–ò–ó –° –¢–û–ß–ù–´–ú–ò –î–ê–ù–ù–´–ú–ò
            function analyzeScreenshotWithPrecision(file, img, template) {
                // –ê–Ω–∞–ª–∏–∑ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
                const fileName = file.name.toLowerCase();
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–∞—Ä—à—Ä—É—Ç –ø–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
                let detectedRoute = null;
                let detectedBusNumber = null;
                
                // –ü–æ–∏—Å–∫ –º–∞—Ä—à—Ä—É—Ç–∞ –≤ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
                for (const route of template.routes) {
                    const routeKeywords = route.name.toLowerCase().split(' ');
                    const hasRouteKeywords = routeKeywords.some(keyword => 
                        fileName.includes(keyword) && keyword.length > 3
                    );
                    
                    if (hasRouteKeywords) {
                        detectedRoute = route.name;
                        // –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π –Ω–æ–º–µ—Ä –∞–≤—Ç–æ–±—É—Å–∞ –∏–∑ —à–∞–±–ª–æ–Ω–∞
                        detectedBusNumber = route.busNumbers[0];
                        break;
                    }
                }
                
                // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –ø–æ –∏–º–µ–Ω–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
                if (!detectedRoute) {
                    // –ë–æ–ª—å—à–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ–±—ã—á–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç –±–æ–ª—å—à–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
                    if (img.width > 2000 || img.height > 2000) {
                        detectedRoute = template.routes[0].name;
                        detectedBusNumber = template.routes[0].busNumbers[0];
                    } else {
                        // –ú–∞–ª–µ–Ω—å–∫–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è - —Å–ª—É—á–∞–π–Ω—ã–π –≤—ã–±–æ—Ä –∏–∑ —à–∞–±–ª–æ–Ω–∞
                        const randomRoute = template.routes[Math.floor(Math.random() * template.routes.length)];
                        detectedRoute = randomRoute.name;
                        detectedBusNumber = randomRoute.busNumbers[0];
                    }
                }
                
                return {
                    success: true,
                    carrier: template.carrier,
                    route: detectedRoute,
                    busNumber: detectedBusNumber
                };
            }

            // –í–´–ë–û–† –ò–ó –®–ê–ë–õ–û–ù–ê –ï–°–õ–ò –ê–í–¢–û–†–ê–°–ü–û–ó–ù–ê–ù–ò–ï –ù–ï –°–†–ê–ë–û–¢–ê–õ–û
            function showTemplateSelection(template) {
                let routeButtons = template.routes.map((route, index) => ({
                    type: 'default',
                    text: `üöå ${route.name}`,
                    id: `route_${index}`
                }));
                
                routeButtons.push({ type: 'cancel', text: '–û—Ç–º–µ–Ω–∞' });
                
                tg.showPopup({
                    title: "–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç",
                    message: `–ü–µ—Ä–µ–≤–æ–∑—á–∏–∫: ${template.carrier}`,
                    buttons: routeButtons
                }, (selectedRouteId) => {
                    if (selectedRouteId && selectedRouteId !== 'cancel') {
                        const routeIndex = parseInt(selectedRouteId.split('_')[1]);
                        const selectedRoute = template.routes[routeIndex];
                        
                        // –í—ã–±–æ—Ä –Ω–æ–º–µ—Ä–∞ –∞–≤—Ç–æ–±—É—Å–∞
                        let busButtons = selectedRoute.busNumbers.map((bus, index) => ({
                            type: 'default',
                            text: `üî¢ ${bus}`,
                            id: `bus_${index}`
                        }));
                        
                        busButtons.push({ type: 'cancel', text: '–ù–∞–∑–∞–¥' });
                        
                        tg.showPopup({
                            title: "–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–º–µ—Ä –∞–≤—Ç–æ–±—É—Å–∞",
                            message: `–ú–∞—Ä—à—Ä—É—Ç: ${selectedRoute.name}`,
                            buttons: busButtons
                        }, (selectedBusId) => {
                            if (selectedBusId && selectedBusId !== 'cancel') {
                                const busIndex = parseInt(selectedBusId.split('_')[1]);
                                const selectedBus = selectedRoute.busNumbers[busIndex];
                                
                                // –¢–û–ß–ù–û–ï –ó–ê–ü–û–õ–ù–ï–ù–ò–ï
                                document.getElementById('carrierInput').value = template.carrier;
                                document.getElementById('routeInput').value = selectedRoute.name;
                                document.getElementById('busNumberInput').value = selectedBus;
                                
                                tg.showPopup({
                                    title: "‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã!",
                                    message: `–í—Å–µ –ø–æ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã —Ç–æ—á–Ω–æ`,
                                    buttons: [{ type: 'ok', text: '–û—Ç–ª–∏—á–Ω–æ!' }]
                                });
                            }
                        });
                    }
                });
            }

            // –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ò–ù–î–ò–ö–ê–¢–û–†–ê –ó–ê–ì–†–£–ó–ö–ò
            function showLoading(text = '–ó–∞–≥—Ä—É–∑–∫–∞...') {
                document.getElementById('loadingText').textContent = text;
                document.getElementById('loadingOverlay').style.display = 'flex';
            }

            function hideLoading() {
                document.getElementById('loadingOverlay').style.display = 'none';
            }

            function setPrice(price) {
                ticketPrice = parseFloat(price);
                document.getElementById('currentPriceText').textContent = ticketPrice.toFixed(2) + ' ‚ÇΩ';
                document.getElementById('priceOptions').style.display = 'none';
                updatePrice();
            }

            function applyCustomPrice() {
                const val = document.getElementById('customPriceInput').value.trim();
                if (val && parseFloat(val) > 0) {
                    setPrice(parseFloat(val));
                }
            }

            function updatePrice() {
                const qty = document.getElementById('quantityRange').value;
                document.getElementById('quantityValue').textContent = qty;
                const total = (ticketPrice * qty).toFixed(2);
                document.getElementById('totalPrice').textContent = total + ' ‚ÇΩ';
            }

            function payTicket() {
                const qty = parseInt(document.getElementById('quantityRange').value);
                const carrier = document.getElementById('carrierInput').value.trim() || "–ò–ü –ß–∏—Ç–∞—â–≤–∏–ª–∏ –ù.–°.";
                const route = document.getElementById('routeInput').value.trim();
                const busNumber = document.getElementById('busNumberInput').value.trim().toLowerCase();
                const totalAmount = (ticketPrice * qty).toFixed(2);
                const ticketNum = `1 ${random3()} ${random3()} ${random3()}`;

                const d = new Date();
                const purchaseDate = d.toLocaleDateString('ru-RU', { day: '2-digit', month: 'long', year: 'numeric' }).replace(' ', ' ').slice(0, -3) + ' –≥.';
                const purchaseTime = d.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });

                tickets.push({ number: ticketNum, carrier, route, busNumber, quantity: qty, price: ticketPrice, created_at: Date.now(), purchaseDate, purchaseTime });
                localStorage.setItem('user_tickets', JSON.stringify(tickets));

                document.getElementById('currentTicketNumber').textContent = ticketNum;
                document.getElementById('controlTicketNumber').textContent = ticketNum;
                document.getElementById('finalCarrier').textContent = carrier;
                document.getElementById('finalRouteFromTo').textContent = route.replace(/-/g, '‚Äî');
                document.getElementById('finalBusNumber').textContent = busNumber;
                document.getElementById('finalCost').textContent = qty + ' —à—Ç., –ü–æ–ª–Ω—ã–π, ' + totalAmount + ' ‚ÇΩ';
                document.getElementById('purchaseDate').textContent = purchaseDate;
                document.getElementById('purchaseTime').textContent = purchaseTime;

                // –ì–ï–ù–ï–†–ê–¶–ò–Ø QR –ö–û–î–ê
                generateQrCode(ticketNum);

                showPage('finalTicketPage');
                switchToTicket();
                startViewTimer();
            }

            function generateQrCode(ticketNumber) {
                const qrContainer = document.getElementById('controlQrCode');
                qrContainer.innerHTML = '';
                new QRCode(qrContainer, {
                    text: ticketNumber,
                    width: 270,
                    height: 270,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
            }

            function switchToTicket() {
                document.getElementById('ticketContent').style.display = 'flex';
                document.getElementById('controlContent').style.display = 'none';
                document.querySelector('.final-ticket-number').style.color = '#FF3B30';
                document.querySelector('.final-control span').style.color = '#888';
                const indicator = document.getElementById('indicator');
                indicator.style.left = '0px';
                indicator.style.width = document.querySelector('.final-ticket-number').offsetWidth + 'px';
            }

            function switchToControl() {
                document.getElementById('ticketContent').style.display = 'none';
                document.getElementById('controlContent').style.display = 'flex';
                document.querySelector('.final-ticket-number').style.color = '#888';
                document.querySelector('.final-control span').style.color = '#FF3B30';
                const controlEl = document.querySelector('.final-control');
                const indicator = document.getElementById('indicator');
                indicator.style.left = (controlEl.getBoundingClientRect().left - controlEl.parentElement.getBoundingClientRect().left) + 'px';
                indicator.style.width = controlEl.offsetWidth + 'px';
            }

            function addNumber(n) { if (enteredCode.length < 6) { enteredCode += n; updateCodeDisplay(); if (enteredCode.length === 6) setTimeout(() => showPage('paymentPage'), 300); } }
            function backspace() { enteredCode = enteredCode.slice(0, -1); updateCodeDisplay(); }
            function updateCodeDisplay() { document.querySelectorAll('.code-box').forEach((b, i) => { b.textContent = enteredCode[i] || ''; b.classList.toggle('filled', i < enteredCode.length); }); }
            function scanCode() { tg.showScanQrPopup({ text: '–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥' }, () => { showPage('paymentPage'); }); }

            function random3() { return Math.floor(Math.random() * 900) + 100; }

            function startViewTimer() {
                viewSecondsLeft = 15;
                document.getElementById('timer').textContent = '–î–µ–π—Å—Ç–≤—É–µ—Ç: ' + viewSecondsLeft + ' —Å–µ–∫.';
                clearInterval(viewTimer);
                viewTimer = setInterval(() => {
                    viewSecondsLeft--;
                    document.getElementById('timer').textContent = '–î–µ–π—Å—Ç–≤—É–µ—Ç: ' + viewSecondsLeft + ' —Å–µ–∫.';
                    if (viewSecondsLeft <= 0) { clearInterval(viewTimer); showPage(tickets.length > 0 ? 'activeTicketsPage' : 'codeInputPage'); renderActiveTickets(); }
                }, 1000);
            }

            function closeTicket() { clearInterval(viewTimer); showPage(tickets.length > 0 ? 'activeTicketsPage' : 'codeInputPage'); renderActiveTickets(); }

            function showPage(id) {
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById(id).classList.add('active');
                if (id === 'finalTicketPage') setTimeout(switchToTicket, 50);
                if (id === 'activeTicketsPage') renderActiveTickets();
            }

            function renderActiveTickets() {
                const list = document.getElementById('activeTicketsList'); list.innerHTML = '';
                if (tickets.length === 0) { list.innerHTML = '<div style="text-align:center;color:#AAA;margin-top:20px;">–ù–µ—Ç –±–∏–ª–µ—Ç–æ–≤</div>'; return; }
                tickets.forEach((t, i) => {
                    const mins = Math.floor((TOTAL_DURATION - (Date.now() - t.created_at)) / 60000);
                    const total = (t.price * t.quantity).toFixed(2);
                    const el = document.createElement('div'); el.className = 'active-ticket-item';
                    el.onclick = () => {
                        document.getElementById('currentTicketNumber').textContent = t.number;
                        document.getElementById('controlTicketNumber').textContent = t.number;
                        document.getElementById('finalCarrier').textContent = t.carrier;
                        document.getElementById('finalRouteFromTo').textContent = t.route.replace(/-/g, '‚Äî');
                        document.getElementById('finalBusNumber').textContent = t.busNumber;
                        document.getElementById('finalCost').textContent = t.quantity + ' —à—Ç., –ü–æ–ª–Ω—ã–π, ' + total + ' ‚ÇΩ';
                        document.getElementById('purchaseDate').textContent = t.purchaseDate;
                        document.getElementById('purchaseTime').textContent = t.purchaseTime;
                        
                        // –ì–ï–ù–ï–†–ê–¶–ò–Ø QR –ö–û–î–ê –ü–†–ò –û–¢–ö–†–´–¢–ò–ò –°–£–©–ï–°–¢–í–£–Æ–©–ï–ì–û –ë–ò–õ–ï–¢–ê
                        generateQrCode(t.number);
                        
                        showPage('finalTicketPage');
                        switchToTicket();
                        startViewTimer();
                    };
                    el.innerHTML = `<div><div style="font-weight:600;">–ë–∏–ª–µ—Ç ‚Ññ ${t.number}</div><div style="font-size:14px;color:#AAA">–û—Å—Ç–∞–ª–æ—Å—å: ${mins} –º–∏–Ω</div></div><div class="delete-btn" onclick="event.stopPropagation();deleteTicket(${i})"></div>`;
                    list.appendChild(el);
                });
            }

            function deleteTicket(i) {
                tg.showPopup({ title: "–£–¥–∞–ª–∏—Ç—å –±–∏–ª–µ—Ç?", message: "–ë–µ–∑ –≤–æ–∑–≤—Ä–∞—Ç–∞", buttons: [{ type: 'destructive', text: '–£–¥–∞–ª–∏—Ç—å', id: 'del' }, { type: 'cancel' }] }, b => {
                    if (b === 'del') { tickets.splice(i, 1); localStorage.setItem('user_tickets', JSON.stringify(tickets)); renderActiveTickets(); }
                });
            }

            document.addEventListener('DOMContentLoaded', () => { 
                updateCodeDisplay(); 
                updatePrice();
            });
        }
    </script>
</body>
</html>
