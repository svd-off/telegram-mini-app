<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Городской Транспорт</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;background:#000;color:#FFF;height:100vh;overflow:hidden;overflow:hidden;}
        .app-container{height:100%;display:flex;flex-direction:column;padding:0 16px 30px 16px;}
        .top-separator{height:1px;background:#2C2C2E;margin:4px 0 10px 0;}
        .final-timer{font-size:26px;font-weight:500;text-align:center;margin:0 0 20px;line-height:1.2;}
        .page{display:none;flex-direction:column;height:100%;}.page.active{display:flex;}
        .final-header-row{display:flex;justify-content:space-between;align-items:center;padding-bottom:12px;border-bottom:1px solid #2C2C2E;margin-bottom:8px;position:relative;}
        .final-ticket-number{display:flex;align-items:center;gap:12px;color:#FF3B30;cursor:pointer;z-index:2;}
        .ticket-icon{width:48px;height:48px;flex-shrink:0;}
        #currentTicketNumber{font-size:21px;font-weight:500;letter-spacing:0.3px;white-space:nowrap;}
        .final-control{display:flex;align-items:center;gap:12px;font-size:18px;color:#888;cursor:pointer;z-index:2;}
        .control-icon{width:48px;height:48px;flex-shrink:0;}
        .tab-indicator{position:absolute;bottom:-1px;height:2.5px;background:#FF3B30;border-radius:2px;transition:all 0.3s ease;z-index:1;}
        .ticket-content{flex:1;display:flex;flex-direction:column;}
        }
        .control-content{flex:1;display:none;flex-direction:column;justify-content:flex-start;}
        .final-info-block{flex:1;}
        .info-row{display:flex;align-items:flex-start;gap:0;padding:6px 0 7px;border-bottom:1px solid #2C2C2E;}
        .info-row:last-child{border-bottom:none;}
        .info-icon.big{width:60px;height:60px;margin-right:16px;margin-top:-3px;flex-shrink:0;}
        .info-content{flex:1;}
        .info-label,.route-fromto{font-size:15px;color:#AAA;font-weight:500;margin-bottom:2px;}
        .info-value,.route-number{font-size:19px;font-weight:600;color:#FFF;}
        .final-close-btn{background:#FF3B30;color:#FFF;font-size:19px;font-weight:600;padding:18px 0;border-radius:16px;text-align:center;cursor:pointer;margin-top:28px;}
        .final-close-btn:active{background:#D91A10;}
        .pay-button{background:#30D158;color:#000;font-size:18px;font-weight:600;padding:20px;border-radius:16px;text-align:center;margin-top:auto;cursor:pointer;}
        .pay-button:active{background:#28A745;}
        .active-tickets-list{flex:1;overflow-y:auto;margin-bottom:12px;}
        .active-ticket-item{background:#1E1E1E;border-radius:12px;padding:16px;margin-bottom:12px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;}
        .active-ticket-item:active{background:#2A2A2C;}
        .delete-btn{width:32px;height:32px;background:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="%23FF3B30" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1-2-2h4a2 2 0 0 1-2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>') center/20px no-repeat;cursor:pointer;}
        .close-button{background:#333;color:#FFF;padding:16px;border-radius:12px;text-align:center;font-size:17px;margin-top:16px;cursor:pointer;}
        #accessDenied{position:fixed;top:0;left:0;width:100%;height:100%;background:#000;display:flex;align-items:center;justify-content:center;z-index:9999;font-size:52px;font-weight:900;color:#FF3B30;}

        /* НОВЫЕ СТИЛИ */
        .paste-area{
            width:100%;
            min-height:160px;
            background:#1A1A1A;
            border:2px dashed #007AFF;
            border-radius:16px;
            padding:20px;
            margin:16px 0;
            font-size:17px;
            color:#FFF;
            resize:none;
            outline:none;
        }
        .parse-btn{
            background:#007AFF;
            color:#FFF;
            text-align:center;
            padding:18px;
            border-radius:16px;
            font-size:18px;
            font-weight:600;
            margin:10px 0 20px 0;
            cursor:pointer;
        }
        .parse-btn:active{background:#0051BB;}
        input[type=text], textarea{
            background:#1E1E1E;
            border:1px solid #3A3A3C;
            border-radius:12px;
            padding:14px;
            color:#FFF;
            font-size:16px;
            width:100%;
            margin-bottom:16px;
        }
        .price-options{margin-top:10px;display:none;background:#111;padding:12px;border-radius:10px;}
        .price-btn{background:#333;color:#FFF;padding:12px;border-radius:10px;text-align:center;margin-bottom:8px;cursor:pointer;}
        .custom-price-row{display:flex;gap:8px;margin-top:8px;}
        .custom-price{flex:1;background:#000;border:1px solid #444;padding:12px;border-radius:10px;color:#FFF;text-align:center;}
        .apply-btn{background:#30D158;color:#000;padding:12px 16px;border-radius:10px;cursor:pointer;}
        .qr-container{display:flex;flex-direction:column;align-items:center;justify-content:flex-start;flex:1;padding-top:10px;}
        .qr-code-wrapper{background:#FFF;padding:30px;border-radius:16px;margin-bottom:20px;}
        #controlQrCode{width:270px!important;height:270px!important;}
    </style>
</head>
<body>

<div id="accessDenied" style="display:none;">ДОСТУП ЗАПРЕЩЁН</div>

<div class="app-container" id="mainApp" style="display:none;">

    <!-- ОПЛАТА -->
    <div id="paymentPage" class="page active">
        <div style="font-size:19px;font-weight:600;margin:16px 0 8px;">Данные билета</div>

        <textarea class="paste-area" id="rawTextInput" placeholder="Вставь сюда ВЕСЬ текст с билета (любой мусор, ошибки — не важно)"></textarea>

        <div class="parse-btn" onclick="smartParse()">РАСПОЗНАТЬ АВТОМАТОМ</div>

        <input type="text" id="carrierInput" placeholder="Перевозчик">
        <input type="text" id="routeInput" placeholder="Маршрут">
        <input type="text" id="busNumberInput" placeholder="Номер автобуса">

        <div style="display:flex;align-items:center;margin:25px 0;">
            <span style="font-size:22px;color:#FF3B30;font-weight:600;" id="quantityValue">1</span>
            <input type="range" min="1" max="10" value="1" id="quantityRange" oninput="updatePrice()" style="flex:1;height:6px;background:#333;border-radius:6px;margin:0 16px;">
            <span style="color:#666;font-size:18px;">10</span>
        </div>

        <div style="background:#1E1E1E;padding:16px;border-radius:12px;margin:16px 0;cursor:pointer;" onclick="document.getElementById('priceOptions').style.display=document.getElementById('priceOptions').style.display==='block'?'none':'block'">
            Цена за 1 билет: <span id="currentPriceText" style="font-weight:600;">48.00 ₽</span>
        </div>
        <div id="priceOptions" class="price-options">
            <div class="price-btn" onclick="setPrice(48)">48.00 ₽</div>
            <div class="price-btn" onclick="setPrice(46)">46.00 ₽</div>
            <div class="custom-price-row">
                <input type="number" id="customPriceInput" class="custom-price" placeholder="Своя цена">
                <div class="apply-btn" onclick="applyCustomPrice()">OK</div>
            </div>
        </div>

        <div class="pay-button" onclick="payTicket()">ОПЛАТИТЬ — <span id="totalPrice">48.00 ₽</span></div>
    </div>

    <!-- ФИНАЛЬНЫЙ БИЛЕТ -->
    <div id="finalTicketPage" class="page">
        <div style="flex:1;display:flex;flex-direction:column;">
            <div class="top-separator"></div>
            <div class="final-timer" id="timer">Действует: 15 сек.</div>
            <div class="final-header-row">
                <div class="final-ticket-number" onclick="switchToTicket()">
                    <img src="big-ticket.png" class="ticket-icon" alt="Билет">
                    <span id="currentTicketNumber">1 314 306 766</span>
                </div>
                <div class="final-control" onclick="switchToControl()">
                    <img src="control.png" class="control-icon" alt="Контроль">
                    <span>Контроль</span>
                </div>
                <div class="tab-indicator" id="indicator"></div>
            </div>

            <div id="ticketContent" class="ticket-content">
                <div class="final-info-block">
                    <div class="info-row">
                        <img src="carrier.png" class="info-icon big">
                        <div class="info-content">
                            <div class="info-label">Перевозчик</div>
                            <div class="info-value" id="finalCarrier">ИП Читащвили Н.С.</div>
                        </div>
                    </div>
                    <div class="info-row">
                        <img src="bus.png" class="info-icon big">
                        <div class="info-content">
                            <div class="route-fromto" id="finalRouteFromTo">Соколовская — Стела</div>
                            <div class="route-number" id="finalBusNumber">в523ок124</div>
                        </div>
                    </div>
                    <div class="info-row">
                        <img src="rub.png" class="info-icon big">
                        <div class="info-content">
                            <div class="info-label">Стоимость</div>
                            <div class="info-value" id="finalCost">1 шт., Полный, 48.00 ₽</div>
                        </div>
                    </div>
                    <div class="info-row">
                        <img src="calendar.png" class="info-icon big">
                        <div class="info-content">
                            <div class="info-label">Дата</div>
                            <div class="info-value" id="purchaseDate">1 декабря 2025 г.</div>
                        </div>
                    </div>
                    <div class="info-row">
                        <img src="clock.png" class="info-icon big">
                        <div class="info-content">
                            <div class="info-label">Время</div>
                            <div class="info-value" id="purchaseTime">14:20</div>
                        </div>
                    </div>
                </div>
                <div class="final-close-btn" onclick="closeTicket()">ЗАКРЫТЬ</div>
            </div>

            <div id="controlContent" class="control-content">
                <div class="qr-container">
                    <div class="qr-code-wrapper">
                        <div id="controlQrCode"></div>
                    </div>
                    <div class="control-ticket-number">
                        <span>№ </span><span id="controlTicketNumber">1 314 306 766</span>
                    </div>
                </div>
                <div class="final-close-btn" onclick="closeTicket()">ЗАКРЫТЬ</div>
            </div>
        </div>
    </div>

    <!-- АКТИВНЫЕ БИЛЕТЫ -->
    <div id="activeTicketsPage" class="page">
        <div style="flex:1;display:flex;flex-direction:column;">
            <div style="font-size:19px;font-weight:600;margin:16px 0;">Действующие билеты</div>
            <div class="active-tickets-list" id="activeTicketsList"></div>
            <div class="close-button" onclick="showPage('paymentPage')">Назад</div>
        </div>
    </div>
</div>

<script>
    const ALLOWED_USERS = [6107814655, 1777702236];
    const tg = window.Telegram.WebApp;
    tg.expand(); tg.MainButton.hide();
    const userId = tg.initDataUnsafe?.user?.id || 0;

    if (!ALLOWED_USERS.includes(userId)) {
        document.getElementById('accessDenied').style.display = 'flex';
    } else {
        document.getElementById('mainApp').style.display = 'flex';
    }

    let viewTimer, viewSecondsLeft = 15;
    const TOTAL_DURATION = 90 * 60 * 1000;
    let tickets = JSON.parse(localStorage.getItem('user_tickets') || '[]');
    const now = Date.now();
    tickets = tickets.filter(t => now - t.created_at < TOTAL_DURATION);
    localStorage.setItem('user_tickets', JSON.stringify(tickets));

    if (tickets.length > 0) {
        showPage('activeTicketsPage');
        renderActiveTickets();
    } else {
        showPage('paymentPage');
    }

    let ticketPrice = 48.00;

    // ГЛАВНЫЙ ПАРСЕР — РАБОТАЕТ НА 1000%
    function smartParse() {
        const text = document.getElementById('rawTextInput').value.trim();
        if (!text) return tg.showAlert('Вставь текст!');

        const lower = text.toLowerCase();

        let carrier = 'ИП Читащвили Н.С.';
        let route = '';
        let busNumber = '';

        // Перевозчик
        if (lower.includes('читащвили')) carrier = 'ИП Читащвили Н.С.';
        else if (lower.includes('иванов')) carrier = 'ИП Иванов А.В.';
        else if (lower.includes('петров')) carrier = 'ИП Петров С.К.';
        else if (lower.includes('ип')) {
            const m = text.match(/(?:ИП|ип)[\s:]*([А-Яа-яЁё\s.]+)/i);
            if (m) carrier = 'ИП ' + m[1].trim();
        }

        // Маршрут
        const routeMatch = text.match(/([А-ЯЁ][а-яё]+\s*[—–—-]\s*[А-ЯЁ][а-яё]+)/);
        if (routeMatch) route = routeMatch[0].replace(/[–—-]/g, '—').trim();

        // Номер автобуса
        const busMatch = text.match(/([а-яa-z]\d{3}[а-яa-z]{2}\d{2,3})/i);
        if (busMatch) busNumber = busMatch[0].toLowerCase();

        // Заполняем
        document.getElementById('carrierInput').value = carrier;
        document.getElementById('routeInput').value = route || 'Соколовская — Стела';
        document.getElementById('busNumberInput').value = busNumber || 'в523ок124';

        tg.showPopup({title:"ГОТОВО!", message:`Перевозчик: ${carrier}\nМаршрут: ${route||'—'}\nНомер: ${busNumber||'—'}`});
    }

    function setPrice(p){ ticketPrice = p; document.getElementById('currentPriceText').textContent = p.toFixed(2)+' ₽'; document.getElementById('priceOptions').style.display='none'; updatePrice(); }
    function applyCustomPrice(){ const v=document.getElementById('customPriceInput').value; if(v>0) setPrice(parseFloat(v)); }
    function updatePrice(){ const q=document.getElementById('quantityRange').value; document.getElementById('quantityValue').textContent=q; document.getElementById('totalPrice').textContent=(ticketPrice*q).toFixed(2)+' ₽'; }

    function payTicket() {
        const qty = parseInt(document.getElementById('quantityRange').value);
        const carrier = document.getElementById('carrierInput').value.trim() || "ИП Читащвили Н.С.";
        const route = document.getElementById('routeInput').value.trim();
        const busNumber = document.getElementById('busNumberInput').value.trim().toLowerCase();
        const total = (ticketPrice * qty).toFixed(2);
        const num = `1 ${r3()} ${r3()} ${r3()}`;
        const d = new Date();
        const date = d.toLocaleDateString('ru-RU',{day:'2-digit',month:'long',year:'numeric'}).replace(/ \d{4}/,' г.';
        const time = d.toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'});

        tickets.push({number:num, carrier, route, busNumber, quantity:qty, price:ticketPrice, created_at:Date.now(), purchaseDate:date, purchaseTime:time});
        localStorage.setItem('user_tickets', JSON.stringify(tickets));

        document.getElementById('currentTicketNumber').textContent = num;
        document.getElementById('controlTicketNumber').textContent = num;
        document.getElementById('finalCarrier').textContent = carrier;
        document.getElementById('finalRouteFromTo').textContent = route.replace(/-/g,'—');
        document.getElementById('finalBusNumber').textContent = busNumber;
        document.getElementById('finalCost').textContent = `${qty} шт., Полный, ${total} ₽`;
        document.getElementById('purchaseDate').textContent = date;
        document.getElementById('purchaseTime').textContent = time;

        generateQr(num);
        showPage('finalTicketPage');
        switchToTicket();
        startTimer();
    }

    function r3(){return Math.floor(Math.random()*900)+100;}
    function generateQr(t){document.getElementById('controlQrCode').innerHTML=''; new QRCode(document.getElementById('controlQrCode'),{text:t,width:270,height:270,colorDark:"#000",colorLight:"#fff",correctLevel:QRCode.CorrectLevel.H});}
    function switchToTicket(){document.getElementById('ticketContent').style.display='flex';document.getElementById('controlContent').style.display='none';document.querySelector('.final-ticket-number').style.color='#FF3B30';document.querySelector('.final-control span').style.color='#888';document.getElementById('indicator').style.left='0';document.getElementById('indicator').style.width=document.querySelector('.final-ticket-number').offsetWidth+'px';}
    function switchToControl(){document.getElementById('ticketContent').style.display='none';document.getElementById('controlContent').style.display='flex';document.querySelector('.final-ticket-number').style.color='#888';document.querySelector('.final-control span').style.color='#FF3B30';const e=document.querySelector('.final-control');document.getElementById('indicator').style.left=(e.getBoundingClientRect().left-e.parentElement.getBoundingClientRect().left)+'px';document.getElementById('indicator').style.width=e.offsetWidth+'px';}
    function startTimer(){viewSecondsLeft=15;document.getElementById('timer').textContent='Действует: '+viewSecondsLeft+' сек.';clearInterval(viewTimer);viewTimer=setInterval(()=>{viewSecondsLeft--;document.getElementById('timer').textContent='Действует: '+viewSecondsLeft+' сек.';if(viewSecondsLeft<=0){clearInterval(viewTimer);showPage(tickets.length>0?'activeTicketsPage':'paymentPage');renderActiveTickets();}},1000);}
    function closeTicket(){clearInterval(viewTimer);showPage(tickets.length>0?'activeTicketsPage':'paymentPage');renderActiveTickets();}
    function showPage(id){document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));document.getElementById(id).classList.add('active');if(id==='finalTicketPage')setTimeout(switchToTicket,50);}
    
    function renderActiveTickets(){
        const list=document.getElementById('activeTicketsList');list.innerHTML='';
        if(tickets.length===0){list.innerHTML='<div style="text-align:center;color:#AAA;margin-top:30px;">Нет активных билетов</div>';return;}
        tickets.forEach((t,i)=>{
            const mins=Math.floor((TOTAL_DURATION-(Date.now()-t.created_at))/60000);
            const el=document.createElement('div');el.className='active-ticket-item';
            el.onclick=()=>{document.getElementById('currentTicketNumber').textContent=t.number;document.getElementById('controlTicketNumber').textContent=t.number;document.getElementById('finalCarrier').textContent=t.carrier;document.getElementById('finalRouteFromTo').textContent=t.route.replace(/-/g,'—');document.getElementById('finalBusNumber').textContent=t.busNumber;document.getElementById('finalCost').textContent=t.quantity+' шт., Полный, '+(t.price*t.quantity).toFixed(2)+' ₽';document.getElementById('purchaseDate').textContent=t.purchaseDate;document.getElementById('purchaseTime').textContent=t.purchaseTime;generateQr(t.number);showPage('finalTicketPage');switchToTicket();startTimer();};
            el.innerHTML=`<div><div style="font-weight:600;">№ ${t.number}</div><div style="font-size:14px;color:#AAA">Осталось: ${mins} мин</div></div><div class="delete-btn" onclick="event.stopPropagation();del(i)"></div>`;
            list.appendChild(el);
        });
    }
    function del(i){tg.showPopup({title:"Удалить?",message:"Безвозвратно",buttons:[{type:'destructive',text:'Удалить',id:'d'},{type:'cancel'}]},b=>{if(b==='d'){tickets.splice(i,1);localStorage.setItem('user_tickets',JSON.stringify(tickets));renderActiveTickets();}});}
    
    document.addEventListener('DOMContentLoaded',()=>{updatePrice();});
</script>
</body>
</html>
