<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Городской Транспорт</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background: #000000; 
            color: #FFFFFF; 
            height: 100vh; 
            overflow: hidden; 
        }
        
        .app-container { 
            height: 100%; 
            display: flex; 
            flex-direction: column; 
            padding: 16px; 
        }
        
        .page { 
            display: none; 
            flex-direction: column; 
            height: 100%; 
        }
        
        .page.active { 
            display: flex; 
        }

        /* ЭКРАН 1: ВВОД КОДА */
        .code-input-field { 
            display: flex; 
            justify-content: center; 
            gap: 8px; 
            margin-bottom: 16px; 
        }
        
        .code-box { 
            width: 40px; 
            height: 52px; 
            border: 1px solid #3A3A3C; 
            border-radius: 8px; 
            background: #1E1E1E; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 24px; 
            font-weight: 500; 
            color: #FFFFFF; 
        }
        
        .code-box.filled { 
            background: #FFFFFF; 
            color: #000000; 
            border-color: #FFFFFF; 
        }
        
        .header { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            margin-bottom: 32px; 
        }
        
        .header-inner { 
            display: flex; 
            align-items: center; 
        }
        
        .header-icon { 
            width: 20px; 
            height: 20px; 
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="%23FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 9h.01"/><path d="M15 15h.01"/><path d="M9 15h.01"/><path d="M15 9h.01"/><path d="M5 5h4v4H5z"/><path d="M15 5h4v4h-4z"/><path d="M5 15h4v4H5z"/><path d="M15 15h4v4h-4z"/></svg>') no-repeat center; 
            background-size: contain; 
            margin-right: 8px; 
        }
        
        .header-title { 
            font-size: 16px; 
            font-weight: 500; 
            color: #FFFFFF; 
        }
        
        .keyboard-container { 
            border: 1.5px solid #FFFFFF; 
            border-radius: 16px; 
            padding: 16px; 
            background: #000000; 
        }
        
        .keyboard { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 12px; 
            margin-bottom: 12px; 
        }
        
        .key { 
            background: #FFFFFF; 
            color: #000000; 
            border: none; 
            border-radius: 12px; 
            font-size: 28px; 
            font-weight: 500; 
            height: 68px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
        }
        
        .key:active { 
            background: #D1D1D6; 
            transform: scale(0.98); 
        }
        
        .bottom-row { 
            display: flex; 
            justify-content: space-between; 
            gap: 12px; 
        }
        
        .action-btn { 
            flex: 1; 
            background: #1E1E1E; 
            color: #FFFFFF; 
            border: none; 
            border-radius: 12px; 
            font-size: 16px; 
            font-weight: 500; 
            height: 68px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
        }
        
        .action-btn:active { 
            background: #3A3A3C; 
        }
        
        .scan-icon { 
            width: 20px; 
            height: 20px; 
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="%23FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 9h.01"/><path d="M15 15h.01"/><path d="M9 15h.01"/><path d="M15 9h.01"/><path d="M5 5h4v4H5z"/><path d="M15 5h4v4h-4z"/><path d="M5 15h4v4H5z"/><path d="M15 15h4v4h-4z"/></svg>') no-repeat center; 
            background-size: contain; 
            margin-right: 6px; 
        }
        
        .backspace-icon { 
            width: 24px; 
            height: 24px; 
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="%23FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5m7-7-7 7 7 7"/></svg>') no-repeat center; 
            background-size: contain; 
        }
        
        .error-message { 
            color: #FF3B30; 
            font-size: 14px; 
            text-align: center; 
            margin-top: 16px; 
            display: none; 
            font-weight: 500; 
        }

        /* ЭКРАН 3: ФИНАЛЬНЫЙ БИЛЕТ - ПЕРЕДЕЛАН ПОД СКРИНШОТ */
        .final-ticket { 
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .ticket-header-success {
            background: #34C759;
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            margin-bottom: 24px;
        }

        .success-title {
            font-size: 20px;
            font-weight: 600;
            color: #000000;
            margin-bottom: 8px;
        }

        .success-timer {
            font-size: 17px;
            font-weight: 600;
            color: #000000;
        }

        .ticket-card {
            background: #1C1C1E;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #2C2C2E;
        }

        .ticket-main-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #2C2C2E;
        }

        .ticket-number {
            font-size: 20px;
            font-weight: 600;
            color: #FFFFFF;
        }

        .control-button {
            background: #48484A;
            border: none;
            border-radius: 10px;
            padding: 10px 16px;
            font-size: 15px;
            font-weight: 500;
            color: #FFFFFF;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .control-button:active {
            background: #5A5A5C;
        }

        .control-icon {
            width: 16px;
            height: 16px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="%23FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>') no-repeat center;
            background-size: contain;
        }

        .info-section {
            margin-bottom: 20px;
        }

        .info-row {
            display: flex;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .info-icon {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            margin-top: 2px;
            flex-shrink: 0;
        }

        .icon-person {
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23FFFFFF"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>') no-repeat center;
            background-size: contain;
        }

        .icon-bus {
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23FFFFFF"><path d="M18 11H6V6h12v5zM4 16c0 .88.39 1.67 1 2.22V20c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h8v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1.78c.61-.55 1-1.34 1-2.22V6c0-3.5-3.58-4-8-4s-8 .5-8 4v10zm3.5 1c-.83 0-1.5-.67-1.5-1.5S6.67 14 7.5 14s1.5.67 1.5 1.5S8.33 17 7.5 17zm9 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg>') no-repeat center;
            background-size: contain;
        }

        .icon-money {
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23FFFFFF"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg>') no-repeat center;
            background-size: contain;
        }

        .icon-calendar {
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23FFFFFF"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/></svg>') no-repeat center;
            background-size: contain;
        }

        .icon-time {
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23FFFFFF"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>') no-repeat center;
            background-size: contain;
        }

        .info-text {
            flex: 1;
        }

        .info-label {
            color: #8E8E93;
            font-size: 13px;
            font-weight: 400;
            margin-bottom: 4px;
        }

        .info-value {
            color: #FFFFFF;
            font-size: 16px;
            font-weight: 500;
            line-height: 1.3;
        }

        .close-button { 
            background: #FF3B30; 
            color: #FFFFFF; 
            font-size: 17px; 
            font-weight: 600; 
            padding: 16px; 
            border-radius: 12px; 
            text-align: center; 
            cursor: pointer; 
            border: none;
            margin-top: auto;
        }
        
        .close-button:active { 
            background: #D70015; 
        }

        /* Остальные стили остаются как были */
        .payment-page, .active-tickets-page {
            /* Сохраняем существующие стили */
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- ЭКРАН 1: ВВОД КОДА -->
        <div id="codeInputPage" class="page active">
            <div class="code-input-field" id="codeDisplay">
                <div class="code-box"></div>
                <div class="code-box"></div>
                <div class="code-box"></div>
                <div class="code-box"></div>
                <div class="code-box"></div>
                <div class="code-box"></div>
            </div>
            <div class="header">
                <div class="header-inner">
                    <div class="header-icon"></div>
                    <div class="header-title">Введите код с наклейки</div>
                </div>
            </div>
            <div class="keyboard-container">
                <div class="keyboard">
                    <button class="key" onclick="addNumber(1)">1</button>
                    <button class="key" onclick="addNumber(2)">2</button>
                    <button class="key" onclick="addNumber(3)">3</button>
                    <button class="key" onclick="addNumber(4)">4</button>
                    <button class="key" onclick="addNumber(5)">5</button>
                    <button class="key" onclick="addNumber(6)">6</button>
                    <button class="key" onclick="addNumber(7)">7</button>
                    <button class="key" onclick="addNumber(8)">8</button>
                    <button class="key" onclick="addNumber(9)">9</button>
                </div>
                <div class="bottom-row">
                    <button class="action-btn" onclick="scanCode()"><span class="scan-icon"></span>Сканировать</button>
                    <button class="key" onclick="addNumber(0)">0</button>
                    <button class="action-btn" onclick="backspace()"><span class="backspace-icon"></span></button>
                </div>
            </div>
            <div class="error-message" id="errorMessage">Неверный код</div>
        </div>

        <!-- ЭКРАН 3: ФИНАЛЬНЫЙ БИЛЕТ - ПЕРЕДЕЛАН ПОД СКРИНШОТ -->
        <div id="finalTicketPage" class="page">
            <div class="final-ticket">
                <div class="ticket-header-success">
                    <div class="success-title">Билет активирован</div>
                    <div class="success-timer" id="timer">15</div>
                </div>
                
                <div class="ticket-card">
                    <div class="ticket-main-info">
                        <div class="ticket-number" id="ticketNumberDisplay">1 299 814 483</div>
                        <button class="control-button" onclick="switchToControl()">
                            <span class="control-icon"></span>
                            Контроль
                        </button>
                    </div>
                    
                    <div class="info-section">
                        <div class="info-row">
                            <div class="info-icon icon-person"></div>
                            <div class="info-text">
                                <div class="info-label">Перевозчик</div>
                                <div class="info-value">ИП Гапченкова Е. А.</div>
                            </div>
                        </div>
                        
                        <div class="info-row">
                            <div class="info-icon icon-bus"></div>
                            <div class="info-text">
                                <div class="info-label">Маршрут</div>
                                <div class="info-value">7, ст. Красноярск-Северный - ДК Кировский<br>к378тв124</div>
                            </div>
                        </div>
                        
                        <div class="info-row">
                            <div class="info-icon icon-money"></div>
                            <div class="info-text">
                                <div class="info-label">Стоимость</div>
                                <div class="info-value">1 шт., Полный, 48.00 ₽</div>
                            </div>
                        </div>
                        
                        <div class="info-row">
                            <div class="info-icon icon-calendar"></div>
                            <div class="info-text">
                                <div class="info-label">Дата покупки</div>
                                <div class="info-value" id="purchaseDate">15 ноября 2025 г.</div>
                            </div>
                        </div>
                        
                        <div class="info-row">
                            <div class="info-icon icon-time"></div>
                            <div class="info-text">
                                <div class="info-label">Время покупки</div>
                                <div class="info-value" id="purchaseTime">12:08</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button class="close-button" onclick="closeTicket()">ЗАКРЫТЬ</button>
            </div>
        </div>

        <!-- Остальные страницы остаются как были -->
        <div id="paymentPage" class="page">
            <!-- ... существующий код ... -->
        </div>
        
        <div id="activeTicketsPage" class="page">
            <!-- ... существующий код ... -->
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.MainButton.hide();
        tg.setHeaderColor('#000000');
        tg.setBackgroundColor('#000000');
        
        let enteredCode = '';
        const maxCodeLength = 6;
        let viewTimer;
        let viewSecondsLeft = 15;
        const TOTAL_DURATION = 90 * 60 * 1000;

        // === ХРАНЕНИЕ БИЛЕТОВ ===
        let tickets = JSON.parse(localStorage.getItem('user_tickets') || '[]');
        const now = Date.now();
        tickets = tickets.filter(t => now - t.created_at < TOTAL_DURATION);
        localStorage.setItem('user_tickets', JSON.stringify(tickets));

        // === ПРОВЕРКА ПРИ ОТКРЫТИИ ===
        if (tickets.length > 0) {
            showPage('activeTicketsPage');
            renderActiveTickets();
        } else {
            showPage('codeInputPage');
        }

        // === ЭКРАН 1 ===
        function addNumber(num) {
            if (enteredCode.length < maxCodeLength) {
                enteredCode += num;
                updateCodeDisplay();
                if (enteredCode.length === maxCodeLength) setTimeout(checkCode, 300);
            }
        }
        
        function backspace() {
            enteredCode = enteredCode.slice(0, -1);
            updateCodeDisplay();
            hideError();
        }
        
        function updateCodeDisplay() {
            const boxes = document.querySelectorAll('.code-box');
            boxes.forEach((box, i) => {
                box.textContent = i < enteredCode.length ? enteredCode[i] : '';
                box.classList.toggle('filled', i < enteredCode.length);
            });
        }
        
        function checkCode() {
            if (enteredCode.length === 6 && /^\d+$/.test(enteredCode)) {
                showPage('paymentPage');
            } else {
                showError();
            }
        }
        
        function showError() {
            const error = document.getElementById('errorMessage');
            error.style.display = 'block';
            setTimeout(() => {
                enteredCode = '';
                updateCodeDisplay();
                error.style.display = 'none';
            }, 1500);
        }
        
        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }
        
        function scanCode() { 
            alert("Сканирование QR (заглушка)"); 
        }

        // === ЭКРАН 2 ===
        function payTicket() {
            const ticketNum = `1 ${random3()} ${random3()} ${random3()}`;
            const createdAt = Date.now();

            // Сохраняем билет
            tickets.push({ number: ticketNum, created_at: createdAt });
            localStorage.setItem('user_tickets', JSON.stringify(tickets));

            // Обновляем отображение номера билета
            document.getElementById('ticketNumberDisplay').textContent = ticketNum;

            // Отправляем в бота
            tg.sendData(JSON.stringify({ 
                action: "ticket_created",
                ticket_num: ticketNum 
            }));

            showPage('finalTicketPage');
            startViewTimer();
        }

        function random3() {
            return Math.floor(Math.random() * 900) + 100;
        }

        // === ЭКРАН 3 ===
        function startViewTimer() {
            viewSecondsLeft = 15;
            updateViewTimer();
            viewTimer = setInterval(() => {
                viewSecondsLeft--;
                updateViewTimer();
                if (viewSecondsLeft <= 0) {
                    clearInterval(viewTimer);
                    showPage('activeTicketsPage');
                    renderActiveTickets();
                }
            }, 1000);
        }
        
        function updateViewTimer() {
            document.getElementById('timer').textContent = viewSecondsLeft;
        }
        
        function closeTicket() {
            clearInterval(viewTimer);
            showPage('activeTicketsPage');
            renderActiveTickets();
        }
        
        function switchToControl() {
            alert("Вкладка 'Контроль' пока не работает");
        }

        // === УДАЛЕНИЕ С КОРЗИНОЙ + ПОДТВЕРЖДЕНИЕ ===
        function deleteTicket(index) {
            tg.showPopup({
                title: "Удалить билет?",
                message: `Вы уверены, что хотите удалить билет № ${tickets[index].number}?`,
                buttons: [
                    { type: 'destructive', text: 'Удалить', id: 'delete' },
                    { type: 'cancel', text: 'Отмена', id: 'cancel' }
                ]
            }, (btnId) => {
                if (btnId === 'delete') {
                    tickets.splice(index, 1);
                    localStorage.setItem('user_tickets', JSON.stringify(tickets));
                    renderActiveTickets();
                }
            });
        }

        function renderActiveTickets() {
            const list = document.getElementById('activeTicketsList');
            if (!list) return;
            
            list.innerHTML = '';
            if (tickets.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: #AAAAAA; margin-top: 20px;">Нет действующих билетов</div>';
                return;
            }
            
            const now = Date.now();
            tickets.forEach((ticket, index) => {
                const minsLeft = Math.floor((TOTAL_DURATION - (now - ticket.created_at)) / 60000);
                const item = document.createElement('div');
                item.className = 'active-ticket-item';
                item.onclick = (e) => {
                    if (e.target.closest('.delete-btn')) return;
                    document.getElementById('ticketNumberDisplay').textContent = ticket.number;
                    showPage('finalTicketPage');
                    startViewTimer();
                };
                item.innerHTML = `
                    <div class="active-ticket-info">
                        <div class="active-ticket-number">Билет № ${ticket.number}</div>
                        <div class="active-ticket-time">Осталось: ${minsLeft} мин</div>
                    </div>
                    <div class="delete-btn" onclick="deleteTicket(${index}); event.stopPropagation();"></div>
                `;
                list.appendChild(item);
            });
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            if (pageId === 'activeTicketsPage') {
                renderActiveTickets();
            }
        }

        // Инициализация
        document.addEventListener('DOMContentLoaded', () => {
            const now = new Date();
            document.getElementById('purchaseDate').textContent = now.toLocaleDateString('ru-RU', { 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric' 
            }) + ' г.';
            
            document.getElementById('purchaseTime').textContent = now.toLocaleTimeString('ru-RU', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            updateCodeDisplay();
        });
    </script>
</body>
</html>
